
-- node box {x=0, y=0, z=0}
node_box_bottle = {
  type = "fixed",
  fixed = {
    {-0.125,-0.25,-0.3125,0.125,-0.0625,-0.25},
    {-0.0625,-0.375,-0.25,0.0625,-0.25,-0.1875},
    {-0.125,-0.3125,-0.25,-0.0625,-0.25,-0.1875},
    {0.0625,-0.3125,-0.25,0.125,-0.25,-0.1875},
    {-0.1875,-0.25,-0.25,-0.125,-0.0625,-0.1875},
    {0.125,-0.25,-0.25,0.1875,-0.0625,-0.1875},
    {-0.125,-0.0625,-0.25,0.125,0.0625,-0.1875},
    {-0.125,0.1875,-0.25,0.125,0.25,-0.1875},
    {-0.0625,-0.4375,-0.1875,0.0625,-0.375,-0.125},
    {-0.125,-0.375,-0.1875,-0.0625,-0.3125,-0.125},
    {0.0625,-0.375,-0.1875,0.125,-0.3125,-0.125},
    {-0.1875,-0.3125,-0.1875,-0.125,-0.25,-0.125},
    {0.125,-0.3125,-0.1875,0.1875,-0.25,-0.125},
    {-0.25,-0.25,-0.1875,-0.1875,-0.0625,-0.125},
    {0.1875,-0.25,-0.1875,0.25,-0.0625,-0.125},
    {-0.1875,-0.0625,-0.1875,-0.125,0.0625,-0.125},
    {0.125,-0.0625,-0.1875,0.1875,0.0625,-0.125},
    {-0.125,0.0625,-0.1875,0.125,0.1875,-0.125},
    {-0.1875,0.1875,-0.1875,-0.125,0.25,-0.125},
    {0.125,0.1875,-0.1875,0.1875,0.25,-0.125},
    {-0.0625,-0.5,-0.125,0.0625,-0.4375,0.125},
    {-0.125,-0.4375,-0.125,-0.0625,-0.375,-0.0625},
    {0.0625,-0.4375,-0.125,0.125,-0.375,-0.0625},
    {-0.1875,-0.375,-0.125,-0.125,-0.3125,-0.0625},
    {0.125,-0.375,-0.125,0.1875,-0.3125,-0.0625},
    {-0.25,-0.3125,-0.125,-0.1875,-0.25,0.125},
    {0.1875,-0.3125,-0.125,0.25,-0.25,0.125},
    {-0.3125,-0.25,-0.125,-0.25,-0.0625,0.125},
    {0.25,-0.25,-0.125,0.3125,-0.0625,0.125},
    {-0.25,-0.0625,-0.125,-0.1875,0.0625,0.125},
    {0.1875,-0.0625,-0.125,0.25,0.0625,0.125},
    {-0.1875,0.0625,-0.125,-0.125,0.1875,0.125},
    {0.125,0.0625,-0.125,0.1875,0.1875,0.125},
    {-0.25,0.1875,-0.125,-0.1875,0.25,0.125},
    {0.1875,0.1875,-0.125,0.25,0.25,0.125},
    {-0.125,-0.5,-0.0625,-0.0625,-0.4375,0.0625},
    {0.0625,-0.5,-0.0625,0.125,-0.4375,0.0625},
    {-0.1875,-0.4375,-0.0625,-0.125,-0.375,0.0625},
    {0.125,-0.4375,-0.0625,0.1875,-0.375,0.0625},
    {-0.25,-0.375,-0.0625,-0.1875,-0.3125,0.0625},
    {0.1875,-0.375,-0.0625,0.25,-0.3125,0.0625},
    {-0.125,-0.4375,0.0625,-0.0625,-0.375,0.125},
    {0.0625,-0.4375,0.0625,0.125,-0.375,0.125},
    {-0.1875,-0.375,0.0625,-0.125,-0.3125,0.125},
    {0.125,-0.375,0.0625,0.1875,-0.3125,0.125},
    {-0.0625,-0.4375,0.125,0.0625,-0.375,0.1875},
    {-0.125,-0.375,0.125,-0.0625,-0.3125,0.1875},
    {0.0625,-0.375,0.125,0.125,-0.3125,0.1875},
    {-0.1875,-0.3125,0.125,-0.125,-0.25,0.1875},
    {0.125,-0.3125,0.125,0.1875,-0.25,0.1875},
    {-0.25,-0.25,0.125,-0.1875,-0.0625,0.1875},
    {0.1875,-0.25,0.125,0.25,-0.0625,0.1875},
    {-0.1875,-0.0625,0.125,-0.125,0.0625,0.1875},
    {0.125,-0.0625,0.125,0.1875,0.0625,0.1875},
    {-0.125,0.0625,0.125,0.125,0.1875,0.1875},
    {-0.1875,0.1875,0.125,-0.125,0.25,0.1875},
    {0.125,0.1875,0.125,0.1875,0.25,0.1875},
    {-0.0625,-0.375,0.1875,0.0625,-0.25,0.25},
    {-0.125,-0.3125,0.1875,-0.0625,-0.25,0.25},
    {0.0625,-0.3125,0.1875,0.125,-0.25,0.25},
    {-0.1875,-0.25,0.1875,-0.125,-0.0625,0.25},
    {0.125,-0.25,0.1875,0.1875,-0.0625,0.25},
    {-0.125,-0.0625,0.1875,0.125,0.0625,0.25},
    {-0.125,0.1875,0.1875,0.125,0.25,0.25},
    {-0.125,-0.25,0.25,0.125,-0.0625,0.3125},
  },
}

-- node box {x=0, y=0, z=0}
node_box_cork = {
  type = "fixed",
  fixed = {
    {-0.125,-0.25,-0.3125,0.125,-0.0625,-0.25},
    {-0.0625,-0.375,-0.25,0.0625,-0.25,-0.1875},
    {-0.125,-0.3125,-0.25,-0.0625,-0.25,-0.1875},
    {0.0625,-0.3125,-0.25,0.125,-0.25,-0.1875},
    {-0.1875,-0.25,-0.25,-0.125,-0.0625,-0.1875},
    {0.125,-0.25,-0.25,0.1875,-0.0625,-0.1875},
    {-0.125,-0.0625,-0.25,0.125,0.0625,-0.1875},
    {-0.125,0.1875,-0.25,0.125,0.25,-0.1875},
    {-0.0625,-0.4375,-0.1875,0.0625,-0.375,-0.125},
    {-0.125,-0.375,-0.1875,-0.0625,-0.3125,-0.125},
    {0.0625,-0.375,-0.1875,0.125,-0.3125,-0.125},
    {-0.1875,-0.3125,-0.1875,-0.125,-0.25,-0.125},
    {0.125,-0.3125,-0.1875,0.1875,-0.25,-0.125},
    {-0.25,-0.25,-0.1875,-0.1875,-0.0625,-0.125},
    {0.1875,-0.25,-0.1875,0.25,-0.0625,-0.125},
    {-0.1875,-0.0625,-0.1875,-0.125,0.0625,-0.125},
    {0.125,-0.0625,-0.1875,0.1875,0.0625,-0.125},
    {-0.125,0.0625,-0.1875,0.125,0.1875,-0.125},
    {-0.1875,0.1875,-0.1875,-0.125,0.25,-0.125},
    {0.125,0.1875,-0.1875,0.1875,0.25,-0.125},
    {-0.0625,-0.5,-0.125,0.0625,-0.4375,0.125},
    {-0.125,-0.4375,-0.125,-0.0625,-0.375,-0.0625},
    {0.0625,-0.4375,-0.125,0.125,-0.375,-0.0625},
    {-0.1875,-0.375,-0.125,-0.125,-0.3125,-0.0625},
    {0.125,-0.375,-0.125,0.1875,-0.3125,-0.0625},
    {-0.25,-0.3125,-0.125,-0.1875,-0.25,0.125},
    {0.1875,-0.3125,-0.125,0.25,-0.25,0.125},
    {-0.3125,-0.25,-0.125,-0.25,-0.0625,0.125},
    {0.25,-0.25,-0.125,0.3125,-0.0625,0.125},
    {-0.25,-0.0625,-0.125,-0.1875,0.0625,0.125},
    {0.1875,-0.0625,-0.125,0.25,0.0625,0.125},
    {-0.1875,0.0625,-0.125,-0.125,0.1875,0.125},
    {0.125,0.0625,-0.125,0.1875,0.1875,0.125},
    {-0.25,0.1875,-0.125,-0.1875,0.25,0.125},
    {0.1875,0.1875,-0.125,0.25,0.25,0.125},
    {-0.125,-0.5,-0.0625,-0.0625,-0.4375,0.0625},
    {0.0625,-0.5,-0.0625,0.125,-0.4375,0.0625},
    {-0.1875,-0.4375,-0.0625,-0.125,-0.375,0.0625},
    {0.125,-0.4375,-0.0625,0.1875,-0.375,0.0625},
    {-0.25,-0.375,-0.0625,-0.1875,-0.3125,0.0625},
    {0.1875,-0.375,-0.0625,0.25,-0.3125,0.0625},
    {-0.125,-0.4375,0.0625,-0.0625,-0.375,0.125},
    {0.0625,-0.4375,0.0625,0.125,-0.375,0.125},
    {-0.1875,-0.375,0.0625,-0.125,-0.3125,0.125},
    {0.125,-0.375,0.0625,0.1875,-0.3125,0.125},
    {-0.0625,-0.4375,0.125,0.0625,-0.375,0.1875},
    {-0.125,-0.375,0.125,-0.0625,-0.3125,0.1875},
    {0.0625,-0.375,0.125,0.125,-0.3125,0.1875},
    {-0.1875,-0.3125,0.125,-0.125,-0.25,0.1875},
    {0.125,-0.3125,0.125,0.1875,-0.25,0.1875},
    {-0.25,-0.25,0.125,-0.1875,-0.0625,0.1875},
    {0.1875,-0.25,0.125,0.25,-0.0625,0.1875},
    {-0.1875,-0.0625,0.125,-0.125,0.0625,0.1875},
    {0.125,-0.0625,0.125,0.1875,0.0625,0.1875},
    {-0.125,0.0625,0.125,0.125,0.1875,0.1875},
    {-0.1875,0.1875,0.125,-0.125,0.25,0.1875},
    {0.125,0.1875,0.125,0.1875,0.25,0.1875},
    {-0.0625,-0.375,0.1875,0.0625,-0.25,0.25},
    {-0.125,-0.3125,0.1875,-0.0625,-0.25,0.25},
    {0.0625,-0.3125,0.1875,0.125,-0.25,0.25},
    {-0.1875,-0.25,0.1875,-0.125,-0.0625,0.25},
    {0.125,-0.25,0.1875,0.1875,-0.0625,0.25},
    {-0.125,-0.0625,0.1875,0.125,0.0625,0.25},
    {-0.125,0.1875,0.1875,0.125,0.25,0.25},
    {-0.125,-0.25,0.25,0.125,-0.0625,0.3125},
    -- cork
    {-0.125,0.1875,-0.1875,0.125,0.3125,0.1875},
    {-0.125,0.0,-0.125,0.125,0.1875,0.125},
    {-0.1875,0.1875,-0.125,-0.125,0.3125,0.125},
    {0.125,0.1875,-0.125,0.1875,0.3125,0.125},
  },
}

-- node box {x=0, y=0, z=0}
node_box_fill = {
  type = "fixed",
  fixed = {
    {-0.125,-0.25,-0.3125,0.125,-0.0625,-0.25},
    {-0.0625,-0.375,-0.25,0.0625,-0.25,-0.1875},
    {-0.125,-0.3125,-0.25,-0.0625,-0.25,-0.1875},
    {0.0625,-0.3125,-0.25,0.125,-0.25,-0.1875},
    {-0.1875,-0.25,-0.25,-0.125,-0.0625,-0.1875},
    {0.125,-0.25,-0.25,0.1875,-0.0625,-0.1875},
    {-0.125,-0.0625,-0.25,0.125,0.0625,-0.1875},
    {-0.125,0.1875,-0.25,0.125,0.25,-0.1875},
    {-0.0625,-0.4375,-0.1875,0.0625,-0.375,-0.125},
    {-0.125,-0.375,-0.1875,-0.0625,-0.3125,-0.125},
    {0.0625,-0.375,-0.1875,0.125,-0.3125,-0.125},
    {-0.1875,-0.3125,-0.1875,-0.125,-0.25,-0.125},
    {0.125,-0.3125,-0.1875,0.1875,-0.25,-0.125},
    {-0.25,-0.25,-0.1875,-0.1875,-0.0625,-0.125},
    {0.1875,-0.25,-0.1875,0.25,-0.0625,-0.125},
    {-0.1875,-0.0625,-0.1875,-0.125,0.0625,-0.125},
    {0.125,-0.0625,-0.1875,0.1875,0.0625,-0.125},
    {-0.125,0.0625,-0.1875,0.125,0.1875,-0.125},
    {-0.1875,0.1875,-0.1875,-0.125,0.25,-0.125},
    {0.125,0.1875,-0.1875,0.1875,0.25,-0.125},
    {-0.0625,-0.5,-0.125,0.0625,-0.4375,0.125},
    {-0.125,-0.4375,-0.125,-0.0625,-0.375,-0.0625},
    {0.0625,-0.4375,-0.125,0.125,-0.375,-0.0625},
    {-0.1875,-0.375,-0.125,-0.125,-0.3125,-0.0625},
    {0.125,-0.375,-0.125,0.1875,-0.3125,-0.0625},
    {-0.25,-0.3125,-0.125,-0.1875,-0.25,0.125},
    {0.1875,-0.3125,-0.125,0.25,-0.25,0.125},
    {-0.3125,-0.25,-0.125,-0.25,-0.0625,0.125},
    {0.25,-0.25,-0.125,0.3125,-0.0625,0.125},
    {-0.25,-0.0625,-0.125,-0.1875,0.0625,0.125},
    {0.1875,-0.0625,-0.125,0.25,0.0625,0.125},
    {-0.1875,0.0625,-0.125,-0.125,0.1875,0.125},
    {0.125,0.0625,-0.125,0.1875,0.1875,0.125},
    {-0.25,0.1875,-0.125,-0.1875,0.25,0.125},
    {0.1875,0.1875,-0.125,0.25,0.25,0.125},
    {-0.125,-0.5,-0.0625,-0.0625,-0.4375,0.0625},
    {0.0625,-0.5,-0.0625,0.125,-0.4375,0.0625},
    {-0.1875,-0.4375,-0.0625,-0.125,-0.375,0.0625},
    {0.125,-0.4375,-0.0625,0.1875,-0.375,0.0625},
    {-0.25,-0.375,-0.0625,-0.1875,-0.3125,0.0625},
    {0.1875,-0.375,-0.0625,0.25,-0.3125,0.0625},
    {-0.125,-0.4375,0.0625,-0.0625,-0.375,0.125},
    {0.0625,-0.4375,0.0625,0.125,-0.375,0.125},
    {-0.1875,-0.375,0.0625,-0.125,-0.3125,0.125},
    {0.125,-0.375,0.0625,0.1875,-0.3125,0.125},
    {-0.0625,-0.4375,0.125,0.0625,-0.375,0.1875},
    {-0.125,-0.375,0.125,-0.0625,-0.3125,0.1875},
    {0.0625,-0.375,0.125,0.125,-0.3125,0.1875},
    {-0.1875,-0.3125,0.125,-0.125,-0.25,0.1875},
    {0.125,-0.3125,0.125,0.1875,-0.25,0.1875},
    {-0.25,-0.25,0.125,-0.1875,-0.0625,0.1875},
    {0.1875,-0.25,0.125,0.25,-0.0625,0.1875},
    {-0.1875,-0.0625,0.125,-0.125,0.0625,0.1875},
    {0.125,-0.0625,0.125,0.1875,0.0625,0.1875},
    {-0.125,0.0625,0.125,0.125,0.1875,0.1875},
    {-0.1875,0.1875,0.125,-0.125,0.25,0.1875},
    {0.125,0.1875,0.125,0.1875,0.25,0.1875},
    {-0.0625,-0.375,0.1875,0.0625,-0.25,0.25},
    {-0.125,-0.3125,0.1875,-0.0625,-0.25,0.25},
    {0.0625,-0.3125,0.1875,0.125,-0.25,0.25},
    {-0.1875,-0.25,0.1875,-0.125,-0.0625,0.25},
    {0.125,-0.25,0.1875,0.1875,-0.0625,0.25},
    {-0.125,-0.0625,0.1875,0.125,0.0625,0.25},
    {-0.125,0.1875,0.1875,0.125,0.25,0.25},
    {-0.125,-0.25,0.25,0.125,-0.0625,0.3125},
    -- fill
    {-0.125,-0.25,-0.25,0.125,-0.0625,0.25},
    {-0.0625,-0.375,-0.1875,0.0625,-0.25,0.1875},
    {-0.125,-0.3125,-0.1875,-0.0625,-0.25,0.1875},
    {0.0625,-0.3125,-0.1875,0.125,-0.25,0.1875},
    {-0.1875,-0.25,-0.1875,-0.125,-0.0625,0.1875},
    {0.125,-0.25,-0.1875,0.1875,-0.0625,0.1875},
    {-0.0625,-0.4375,-0.125,0.0625,-0.375,0.125},
    {-0.125,-0.375,-0.125,-0.0625,-0.3125,0.125},
    {0.0625,-0.375,-0.125,0.125,-0.3125,0.125},
    {-0.1875,-0.3125,-0.125,-0.125,-0.25,0.125},
    {0.125,-0.3125,-0.125,0.1875,-0.25,0.125},
    {-0.25,-0.25,-0.125,-0.1875,-0.0625,0.125},
    {0.1875,-0.25,-0.125,0.25,-0.0625,0.125},
    {-0.125,-0.4375,-0.0625,-0.0625,-0.375,0.0625},
    {0.0625,-0.4375,-0.0625,0.125,-0.375,0.0625},
    {-0.1875,-0.375,-0.0625,-0.125,-0.3125,0.0625},
    {0.125,-0.375,-0.0625,0.1875,-0.3125,0.0625},
  },
}

local water_nodes = {
  ["default:river_water_source"] = true,
  ["default:river_water_flowing"] = true,
};

if hardcook.use_normal_water then
  water_nodes["default:water_source"] = true;
  water_nodes["default:water_flowing"] = true;
end

local function to_bottle_with_water(itemstack, user, pointed_thing, target_bottle)
  if pointed_thing.type == "object" then
    pointed_thing.ref:punch(user, 1.0, { full_punch_interval=1.0 }, nil)
    return user:get_wielded_item()
  elseif pointed_thing.type ~= "node" then
    -- do nothing if it's neither object nor node
    return
  end
  local node = minetest.get_node(pointed_thing.under);
  local is_water = water_nodes[node.name];
  if is_water then
    hardcook.item_to_inventory(user, ItemStack(target_bottle));
    itemstack:take_item(1);
    return itemstack;
  else
    -- non-liquid nodes will have their on_punch triggered
    local node_def = minetest.registered_nodes[node.name]
    if node_def then
      node_def.on_punch(pointed_thing.under, node, user, pointed_thing)
    end
    return user:get_wielded_item()
  end
end

minetest.register_craftitem( "hardcook:bottle_cork", {
  description = "Cork for bottle",
  inventory_image = "hardcook_bottle_cork_inv.png",
});

minetest.register_node( "hardcook:glass_bottle", {
  description = "Empty open glass bottle",
  drawtype = "mesh",
  paramtype  = "light",
  paramtype2 = "facedir",
  mesh = "hardcook_glass_bottle.obj",
  selection_box = node_box_bottle,
  collision_box = node_box_bottle,
  tiles = {"hardcook_glass_bottle_top.png", "hardcook_glass_bottle_bottom.png", "hardcook_glass_bottle_side.png"},
  use_texture_alpha = "clip",
  --sunlight_propagates = true,
  groups = {oddly_breakable_by_hand = 1, dig_immediate = 2, not_in_creative_inventory = hardcook.use_not_in_creative_inventory},
  liquids_pointable = true,
  on_use = function (itemstack, user, pointed_thing)
      return to_bottle_with_water(itemstack, user, pointed_thing, "hardcook:glass_bottle_with_water");
    end,
})

if (hardcook.have_unified) then
  unified_inventory.register_craft_type("pouring_glass_bottle", {
      description = "pouring";
      icon = "vessels_glass_bottle_inv.png",
      width = 2,
      height = 1,
    })
end

minetest.register_node( "hardcook:glass_bottle_cork", {
  description = "Empty close glass bottle",
  drawtype = "mesh",
  paramtype  = "light",
  paramtype2 = "facedir",
  mesh = "hardcook_glass_bottle_cork.obj",
  selection_box = node_box_cork,
  collision_box = node_box_cork,
  tiles = {"hardcook_glass_bottle_top.png", "hardcook_glass_bottle_bottom.png", "hardcook_glass_bottle_side.png", "hardcook_glass_bottle_cork.png"},
  use_texture_alpha = "clip",
  --sunlight_propagates = true,
  groups = {oddly_breakable_by_hand = 1, dig_immediate = 2, not_in_creative_inventory = hardcook.use_not_in_creative_inventory},
  drop = "vessels:glass_bottle",
  liquids_pointable = true,
  on_use = function (itemstack, user, pointed_thing)
      return to_bottle_with_water(itemstack, user, pointed_thing, "hardcook:glass_bottle_cork_with_water");
    end,
})

hardcook.set_on_place("vessels:glass_bottle", "hardcook:glass_bottle_cork")

minetest.register_node( "hardcook:glass_bottle_with_water", {
  description = "Open glass bottle with water",
  drawtype = "mesh",
  paramtype  = "light",
  paramtype2 = "facedir",
  mesh = "hardcook_glass_bottle_fill.obj",
  selection_box = node_box_fill,
  collision_box = node_box_fill,
  tiles = {"hardcook_glass_bottle_top.png", "hardcook_glass_bottle_bottom.png", "hardcook_glass_bottle_side.png", "default_river_water.png"},
  use_texture_alpha = "clip",
  --sunlight_propagates = true,
  groups = {oddly_breakable_by_hand = 1, dig_immediate = 2, not_in_creative_inventory = hardcook.use_not_in_creative_inventory},
  drop = "vessels:glass_bottle",
})

minetest.register_node( "hardcook:glass_bottle_cork_with_water", {
  description = "Close glass bottle with water",
  drawtype = "mesh",
  paramtype  = "light",
  paramtype2 = "facedir",
  mesh = "hardcook_glass_bottle_fill_cork.obj",
  selection_box = node_box_cork,
  collision_box = node_box_cork,
  tiles = {"hardcook_glass_bottle_top.png", "hardcook_glass_bottle_bottom.png", "hardcook_glass_bottle_side.png", "default_water.png", "hardcook_glass_bottle_cork.png"},
  use_texture_alpha = "clip",
  --sunlight_propagates = true,
  groups = {oddly_breakable_by_hand = 1, dig_immediate = 2, not_in_creative_inventory = hardcook.use_not_in_creative_inventory},
  drop = "vessels:glass_bottle",
})

